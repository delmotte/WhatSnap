<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html"/>
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html"/>
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html"/>
<link rel="import" href="../bower_components/paper-fab/paper-fab.html"/>
<link rel="import" href="side-thumbnail.html"/>

<dom-module id="my-conversation" attributes="conversationId">
    <style>

        @media (max-width: 639px) {
            side-thumbnail{
                top: 56px !important;
            }
            .image-container {
                padding-top: 56px!important;
            }

        }

        paper-toolbar {
            z-index:100;
            position:fixed;
            top:0px;
            width:100%;
        }

        .add-photo {
            position:fixed;
            bottom:0px;
            display:block;
            width:100%;
            text-align:right;

        }

        .add-photo paper-fab {
            top:-12px;
            right:12px;
        }

        side-thumbnail{
            position: fixed;
            left: 0;
            top: 64px;
            z-index: 1000;
            height: 100%;
            background-color: #263238;
            width : 12%;
            overflow: auto;
        }

        .img_container{
            /* width: calc(100% - 6px);*/
            height : 100%;

            background-position: center center !important;
            background-repeat: no-repeat;
            background-size: cover !important;
        }

        .imageContainer{
            height: 60px;
            margin : 3px 3px 0px 3px;

        }

        @media (max-width: 639px) {
            .image-container {
                top:56px!important;
            }
        }
        .image-container {
            top: 64px;
            bottom:0px;
            left: 12%;
            width:88%;
            position: absolute;
            display:block;
            background-color: black;
        }

        .image-container > img {
            position: absolute;
            max-width: 100%;
            top: 10%;
            left: 10%;
            border-radius: 3px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.9);
        }

        .image-container img:empty {
            top: 50%;
            left: 50%;
            -webkit-transform: translate(-50%, -50%);
            -moz-transform: translate(-50%, -50%);
            -ms-transform: translate(-50%, -50%);
            -o-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
        }
        side-thumbnail::-webkit-scrollbar {
            display: none;
        }

        @media screen and (orientation: portrait) {
            .image-container > img:empty { max-width: 100%; }
        }

        @media screen and (orientation: landscape) {
            .image-container > img:empty { max-height: 100%; }
        }

    </style>

    <template>

        <!-- menu bar -->
        <paper-toolbar>
            <paper-icon-button icon="arrow-back" on-up="goBack"></paper-icon-button>
            <div class="title">{{ userName }}</div>
        </paper-toolbar>

        <side-thumbnail>

            <!-- Display all messages -->
            <template is="dom-repeat" items="{{ messages }}" >
                <div class="imageContainer"  >
                    <div id="{{ index }}" class$="{{buildClass(item.image_url)}}" onmousedown="changeMainPicture(this)" ontouchstart="changeMainPicture(this)"  >
                    </div>
                </div>
            </template>
        </side-thumbnail>


        <!-- image container -->
        <div class="image-container" id="messages"></div>

        <!-- add photo from camera -->
        <div class="add-photo">
            <input type="file" id="upload_input" accept="image/*" style="display:none"/>
            <paper-fab id="upload_btn" icon="camera-enhance" on-click="_sendPicture"></paper-fab>
        </div>

    </template>

</dom-module>

<script>
    Polymer({
        is: 'my-conversation',

        properties: {
            messages: {
                type: Array,
                value: []
            },
            userName: {
                type:String,
                value: 'Contact Name'
            }
        },

        goBack: function () {
            document.querySelector('app-router').go('/home');
        },

        attached: function () {

            // find the right conversation
            for (var i in talks) {
                if (talks[i].id == this.conversationId) {
                    this.set('userName', talks[i].name);
                    this.set('messages', talks[i].messages);
                    break;
                }
            }

            // add listener to resize the left side bar
            window.addEventListener("resize", updateWidthSlider, true);

            var self = this;
            setTimeout(function(){

                if(self.messages.length >0){
                    // init image center
                    $('#messages').iviewer({src: self.messages[0].image_url, ui_disabled: true});

                    // listen double tap to zoom in / zoom out
                    (new Hammer(document.querySelector('#messages'), {transform_always_block: true, taps:2})).on('doubletap', function () {
                        if (tapCounter == false) {
                            $('#messages').iviewer('zoom_by', 1.5);
                            tapCounter = true;
                        } else {
                            $('#messages').iviewer('fit');
                            tapCounter = false;
                        }
                    });

                    //encadrer en rouge la premiere image du side slider
                    encadrerImageSlider(0);
                }
                updateWidthSlider();
            }, 100);

        },



        detached: function () {
            window.removeEventListener("resize", updateWidthSlider, true);
        },

        _sendPicture: function () {
            document.querySelector('#upload_input').dispatchEvent(new Event('click'));
        },

        buildClass: function (image_url) {
            return 'img_container img-unique ' + image_url ;
        },

        ready: function () {
            setTimeout(function () {
                var imgs = document.querySelectorAll('.img-unique');
                for (var i = 0; i < imgs.length; i++) {
                    imgs[i].style.background = 'url(' + (''+imgs[i].className).split(' ')[2] + ')';
                }
            });

        }

    });

    /** OUT OF POLYMER :'( #roumainAttitude **/
    var currentPicture = 0;
    function changeMainPicture(urli){
        encadrerImageSlider(urli.id);
        tapCounter = false;
        $('#messages').iviewer('loadImage',  urli.style.background.split('(')[1].split(')')[0]);
        $('#messages').iviewer('fit');
    }

    function updateWidthSlider(){
        var newHeight =window.getComputedStyle(document.querySelector(".imageContainer"), null).getPropertyValue("width");
        var imgs = document.querySelectorAll(".imageContainer");
        for (var i in imgs) {
            try {
                imgs[i].style.height = newHeight;
            } catch (e) {}
        }
    }

    function encadrerImageSlider(number){
        nettoyerCadre(currentPicture);
        document.querySelectorAll(".imageContainer")[number].style.border = "2px solid red";
        currentPicture = number;
    }
    function nettoyerCadre(picture){
        document.querySelectorAll(".imageContainer")[picture].style.border = "none";

    }
    var tapCounter = false;
</script>