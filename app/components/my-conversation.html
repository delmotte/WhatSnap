<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html"/>
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html"/>
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html"/>
<link rel="import" href="../bower_components/paper-fab/paper-fab.html"/>

<dom-module id="my-conversation" attributes="conversationId">
    <style>
        .container {
            margin-top:20px;
            padding-left:20px;
            padding-right:20px;
            text-align:right;
        }

        .container > .bubble-left {
            position:relative;
            top:6px;
            margin-left:75px;
            width: calc(100% - 100px);
            padding: 10px;
            background: #DDDDDD;
            -webkit-border-radius: 10px;
            -moz-border-radius: 10px;
            border-radius: 10px;
        }

        .container > .bubble-right {
            position:relative;
            top:6px;
            margin:auto;
            right:0px;
            margin-right:75px;
            width: calc(100% - 100px);
            padding: 10px;
            background: #DDDDDD;
            -webkit-border-radius: 10px;
            -moz-border-radius: 10px;
            border-radius: 10px;
        }

        .container > .bubble-left img, .container > .bubble-right img {
            width:100%;
            height:auto;
            display:block;
            margin-bottom:10px;
        }

        .container >  .bubble-left:after {
            content: '';
            position: absolute;
            border-style: solid;
            border-width: 7px 21px 7px 0;
            border-color: transparent #DDDDDD;
            display: block;
            width: 0;
            z-index: 1;
            left: -21px;
            top: 14px;
        }

        .container > .bubble-right:after {
            content: '';
            position: absolute;
            border-style: solid;
            border-width: 7px 0px 7px 21px;
            border-color: transparent #DDDDDD;
            display: block;
            width: 0;
            z-index: 1;
            right: -21px;
            top: 14px;
        }

        .messages-container {
            padding-bottom:100px;
            padding-top:64px;
        }

        @media (max-width: 639px) {
            .messages-container {
                padding-top:56px;
            }
        }

        paper-toolbar {
            z-index:100;
            position:fixed;
            top:0px;
            width:100%;
        }

        .add-photo {
            position:fixed;
            bottom:0px;
            display:block;
            width:100%;
            text-align:center;
        }

        .add-photo paper-fab {
            top:-12px;
        }

        img.bubble-right {
            float:right!important;
        }

    </style>

    <template>

        <!-- menu bar -->
        <paper-toolbar>
            <paper-icon-button icon="arrow-back" on-click="goBack"></paper-icon-button>
            <div class="title">{{ userName }}</div>
        </paper-toolbar>

        <!-- message container -->
        <div class="messages-container" id="messages">

            <!-- Display all messages -->
            <template is="dom-repeat" items="{{ messages }}">

                <div class="container">
                    <div class="contact-img">
                        <img  class$="{{leftOrRight(item)}}"
                                src="http://www.iconsfind.com/wp-content/uploads/2015/08/20150831_55e46aeb19862-210x210.png"
                             alt=""
                             style="height:54px;position:relative;float:left;"/>
                    </div>

                    <div class$="{{leftOrRight(item)}}">
                        <img src="{{ item.image_url }}" alt=""/>
                        <div>{{ displayFromAndAt(item) }}</div>
                    </div>
                </div>

            </template>

        </div>

        <!-- add photo from camera -->
        <div class="add-photo">
            <paper-fab icon="camera-enhance"></paper-fab>
        </div>

    </template>

</dom-module>

<script>
    Polymer({
        is: 'my-conversation',

        properties: {
            messages: {
                type: Array,
                value: function () {
                    return [{
                        sendBy: '',
                        sendAt: 'coucou',
                        sendFrom: 'laule',
                        image_url: 'http://soocurious.com/fr/wp-content/uploads/2014/03/des-ours-aux-comportements-humains1.jpg'
                    },{
                        sendBy: '',
                        sendAt: 'coucou',
                        sendFrom: 'laule',
                        image_url: 'http://soocurious.com/fr/wp-content/uploads/2014/03/des-ours-aux-comportements-humains1.jpg'
                    },{
                        sendBy: '+33678469859',
                        sendAt: 'coucou',
                        sendFrom: 'laule',
                        image_url: 'http://soocurious.com/fr/wp-content/uploads/2014/03/des-ours-aux-comportements-humains1.jpg'
                    }];
                }
            },
            isEmpty: {
                type: Boolean,
                value: true
            },
            loading: {
                type:Boolean,
                value: true
            },
            userName: {
                type:String,
                value: 'noone'
            }
        },

        goBack: function () {
            document.querySelector('app-router').go('/home');
        },

        ready: function () {
            var self = this;
            /**
             * When all the images finished to load, scroll to the bottom of the conversation
             */
            this.async(function() {
                var imgs = document.querySelectorAll('.bubble-right img, .bubble-left img');
                var index = 0;
                for (var i = 0; i < imgs.length; i++) {
                    imgs[i].addEventListener('load', function () {
                        index++;
                        if (index == imgs.length) {
                            self.set('loading', false);
                            document.querySelector('body').scrollTop = document.querySelector('body').scrollHeight;
                        }
                    });
                }

            });

        },

        attached: function () {
            if (!UserStore.getSim()) {
                document.querySelector('app-router').go('/');
            }
            var conversation = UserStore.enterConversation(this.conversationId);
            this.set('userName', conversation.name);
            //this.set('messages', conversation.messages);
            var self = this;
            this.id = Dispatcher.register('NEW_MESSAGE', {
                receive: function (conversation) {
                    self.set('messages', conversation.messages);
                }
            });
        },

        detached: function () {
            Dispatcher.destroy({id:this.id});
        },

        leftOrRight: function (item, boolean) {
            return (boolean ? 'img-' : '') + (item.sendBy == UserStore.getSim().phoneNumber ? 'bubble-right' : 'bubble-left');
        },

        displayFromAndAt: function (item) {
            return item.sendAt + ', ' + item.sendFrom;
        }

    });
</script>