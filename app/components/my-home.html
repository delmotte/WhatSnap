<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html"/>
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html"/>
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html"/>
<link rel="import" href="../bower_components/paper-item/paper-item-body.html"/>
<link rel="import" href="../bower_components/paper-item/paper-item.html"/>
<link rel="import" href="../bower_components/paper-badge/paper-badge.html"/>
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html"/>

<dom-module id="my-home">
    <style>
    </style>

    <template>

        <paper-toolbar>
            <paper-icon-button icon="menu"></paper-icon-button>
            <div class="title">WhatSnap</div>
        </paper-toolbar>

        <template is="dom-repeat" items="{{ conversations }}">

            <paper-item on-click="goConversation">
                <div class="avatar green" item-icon>
                    <img src="http://www.iconsfind.com/wp-content/uploads/2015/08/20150831_55e46aeb19862-210x210.png"
                         alt=""
                         style="height:54px;padding:10px;"/>
                </div>
                <paper-item-body two-line class="layout vertical">
                    <div>{{ item.name }}</div>
                    <div secondary>Nothing for the moment</div>
                </paper-item-body>
                <div><paper-badge label="3"></paper-badge></div>
            </paper-item>

        </template>


        <template is="dom-if" if="{{isEmpty}}">
            No one of your contacts use the app !
        </template>

        <iron-ajax
                id="ajax"
                url=""
                method="POST"
                handle-as="json"
                on-response="_handleResponse"></iron-ajax>

    </template>

</dom-module>

<script>
    Polymer({
        is: 'my-home',

        // initialize data
        properties: {
            conversations: {
                type: Array,
                value: function () {
                    return [{_id: 'a', name:'Allan'},{ _id: 'b', name:'Bonjour'}];
                }
            },
            isEmpty: {
                type: Boolean,
                value: true
            }
        },

        ready: function () {
            // Take the real data
            //this.set('customers', Model.customers);
        },

        attached: function () {
            // add this element to the dispatcher
            var self = this;
            this.id = Dispatcher.register('INITIALISATION_DONE', {
                receive: function () {
                    self.$.ajax.url = 'http://localhost:7070/' + ( localStorage.getItem('isSignedIn') ? 'login' : 'signin' );
                    self.$.ajax.params = {
                        phone_number: UserStore.getSim().phoneNumber,
                        contacts: UserStore.getContacts().map(function (contact) {
                            return contact.phoneNumber;
                        })
                    };
                    //self.$.ajax.generateRequest();
                }
            });
            UserStore.init();
        },

        detached: function () {
            Dispatcher.destroy({id:this.id});
        },

        _handleResponse: function (request) {
            if (request.detail.response.status == 'success') {
                if ( !localStorage.getItem('isSignedIn') ) localStorage.setItem('isSignedIn', true);
                UserStore.matchConversationWithName(request.detail.response.data.conversations);
                this.set('conversations', UserStore.getConversations());
            }
        },

        goConversation: function (item) {
            document.querySelector('app-router').go('/conversation/' + item.model.item._id);
        }

    });
</script>